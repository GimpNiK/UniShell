name: Publish All UniShell Packages

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          pip install build twine
      
      - name: Fix license classifiers in all packages
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          
          for dir in unishell unishell-win unishell-unix; do
            if [ ! -d "$dir" ]; then
              echo "âš ï¸ Skipping: $dir not found"
              continue
            fi
            
            echo "========================================"
            echo "ðŸ”§ Fixing: $dir"
            echo "========================================"
            
            pushd "$dir" > /dev/null
            
            # 1. Ð£Ð±ÐµÐ´Ð¸Ð¼ÑÑ, Ñ‡Ñ‚Ð¾ ÐµÑÑ‚ÑŒ pyproject.toml
            if [ ! -f "pyproject.toml" ]; then
              echo "âŒ ERROR: pyproject.toml not found in $dir"
              exit 1
            fi
            
            # 2. ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ
            sed -i "s/^version = \".*\"/version = \"$VERSION\"/" pyproject.toml
            
            # 3. ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¸ (ÐµÑÐ»Ð¸ ÐµÑ‰Ñ‘ Ð½Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾)
            sed -i 's/license = {text = "MIT"}/license = "MIT"/g' pyproject.toml
            
            # 4. Ð£Ð”ÐÐ›Ð¯Ð•Ðœ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ðµ ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ñ‹ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¹
            echo "Removing license classifiers..."
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
            python3 -c "
import tomllib
import tomli_w

with open('pyproject.toml', 'rb') as f:
    data = tomllib.load(f)

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ñ‹ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¹ Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ° classifiers
if 'project' in data and 'classifiers' in data['project']:
    license_classifiers = [
        'License :: OSI Approved :: MIT License',
        'License :: OSI Approved :: MIT',
        'License :: MIT License'
    ]
    
    new_classifiers = [
        c for c in data['project']['classifiers'] 
        if c not in license_classifiers
    ]
    
    # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¾ÑÑŒ
    if len(new_classifiers) != len(data['project']['classifiers']):
        data['project']['classifiers'] = new_classifiers
        print(f'Removed {len(data[\"project\"][\"classifiers\"]) - len(new_classifiers)} license classifiers')
    else:
        print('No license classifiers found')

with open('pyproject.toml', 'wb') as f:
    tomli_w.dump(data, f)
"
            
            # 5. Ð”Ð»Ñ win/unix Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¾Ñ‚ unishell
            if [ "$dir" != "unishell" ]; then
                sed -i "s/^unishell>=.*/unishell>=$VERSION/" pyproject.toml
            fi
            
            popd > /dev/null
          done
      
      - name: Build and publish packages
        run: |
          set -e  # Ð’Ñ‹Ñ…Ð¾Ð´ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ
          VERSION="${GITHUB_REF#refs/tags/}"
          
          for dir in unishell unishell-win unishell-unix; do
            if [ ! -d "$dir" ]; then
              echo "âš ï¸ Skipping: $dir not found"
              continue
            fi
            
            echo "========================================"
            echo "ðŸ› ï¸ Building: $dir"
            echo "========================================"
            
            pushd "$dir" > /dev/null
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð¿ÐµÑ€ÐµÐ´ ÑÐ±Ð¾Ñ€ÐºÐ¾Ð¹
            echo "ðŸ” Final configuration check..."
            echo "License: $(grep '^license =' pyproject.toml || echo 'Not found')"
            echo "Version: $(grep '^version =' pyproject.toml)"
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð¾ÑÑ‚Ð°Ð»Ð¸ÑÑŒ Ð»Ð¸ ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ñ‹ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¹
            if grep -q "License :: OSI Approved" pyproject.toml; then
              echo "âŒ ERROR: License classifiers still present!"
              echo "Found: $(grep 'License :: OSI Approved' pyproject.toml)"
              exit 1
            fi
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ README ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
            if [ ! -f "README.md" ] && grep -q 'readme = "README.md"' pyproject.toml; then
              echo "ðŸ“– Creating README.md..."
              echo "# $dir" > README.md
              echo "Version: $VERSION" >> README.md
            fi
            
            # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¸ Ð¿ÑƒÐ±Ð»Ð¸ÐºÑƒÐµÐ¼
            echo "ðŸ”¨ Building package..."
            python -m build
            
            echo "ðŸš€ Uploading to PyPI..."
            twine upload --non-interactive --verbose dist/*
            
            popd > /dev/null
            echo "âœ… Successfully published $dir"
            echo ""
          done
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}