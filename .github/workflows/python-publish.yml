name: Publish Packages

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      # 1. Устанавливаем ВСЕ необходимые инструменты ДО цикла
      - name: Install build and publishing tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Build and publish all packages
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          
          for dir in unishell unishell-win unishell-unix; do
            echo "================================"
            echo "Building $dir..."
            echo "================================"
            
            if [ ! -d "$dir" ]; then
              echo "❌ Directory $dir not found!"
              continue
            fi
            
            cd "$dir"
            
            # 2. Создаем README.md если его нет (чтобы избежать warnings)
            if [ ! -f "README.md" ]; then
              echo "Creating placeholder README.md..."
              echo "# $dir" > README.md
              echo "Version: $VERSION" >> README.md
            fi
            
            # 3. Обновляем версию и зависимости для win/unix пакетов
            if [ "$dir" != "unishell" ]; then
              echo "Updating version and dependencies..."
              sed -i "s/version = \".*\"/version = \"$VERSION\"/" pyproject.toml
              sed -i "s/unishell>=.*/unishell>=$VERSION/" pyproject.toml
              
              # 4. Также обновляем формат лицензии на SPDX
              if grep -q 'license = {text = "MIT"}' pyproject.toml; then
                echo "Updating license format to SPDX..."
                sed -i 's/license = {text = "MIT"}/license = "MIT"/' pyproject.toml
              fi
            fi
            
            # 5. Обновляем лицензию и в основном пакете
            if grep -q 'license = {text = "MIT"}' pyproject.toml; then
              echo "Updating license format to SPDX..."
              sed -i 's/license = {text = "MIT"}/license = "MIT"/' pyproject.toml
            fi
            
            # 6. Собираем пакет
            echo "Building package..."
            python -m build
            
            # 7. Публикуем на PyPI
            echo "Uploading to PyPI..."
            twine upload --non-interactive --verbose dist/*
            
            cd ..
            echo "✅ $dir published successfully!"
            echo ""
          done
        env:
          # 8. Для безопасности используйте секретное имя PYPI_API_TOKEN
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}