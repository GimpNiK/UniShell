name: Publish All UniShell Packages

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          pip install build twine
      
      - name: Fix packages
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          
          for dir in unishell unishell_win unishell_unix; do
            echo "Fixing $dir..."
            cd "$dir"
            
            # Update version
            sed -i "s/^version = \".*\"/version = \"$VERSION\"/" pyproject.toml
            
            # Update license format
            sed -i 's/license = {text = "MIT"}/license = "MIT"/g' pyproject.toml
            
            # Remove license classifiers using simple sed
            sed -i '/License :: OSI Approved :: MIT License/d' pyproject.toml
            sed -i '/License :: OSI Approved :: MIT/d' pyproject.toml
            sed -i '/License :: MIT License/d' pyproject.toml
            
            # For win/unix packages, update dependency
            if [ "$dir" != "unishell" ]; then
              sed -i "s/^unishell>=.*/unishell>=$VERSION/" pyproject.toml
            fi
            
            cd ..
          done
      
      - name: Build and publish
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          
          for dir in unishell unishell_win unishell_unix; do
            echo "Building $dir..."
            cd "$dir"
            
            # Create README if needed
            if [ ! -f "README.md" ]; then
              echo "# $dir" > README.md
              echo "Version: $VERSION" >> README.md
            fi
            
            python -m build
            twine upload --non-interactive --verbose dist/*
            
            cd ..
          done
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}