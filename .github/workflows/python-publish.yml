name: Publish Packages

on: release

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - run: pip install build
      
      - name: Build and publish
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          
          for dir in unishell unishell-win unishell-unix; do
            echo "Building $dir..."
            cd $dir
            if [ "$dir" != "unishell" ]; then
              sed -i "s/version = \".*\"/version = \"$VERSION\"/" pyproject.toml
              sed -i "s/unishell>=.*/unishell>=$VERSION/" pyproject.toml
            fi
            python -m build
            twine upload --non-interactive --username __token__ --password $PYPI_TOKEN dist/*
            cd ..
          done
        env:
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}